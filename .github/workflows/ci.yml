name: Infrastructure & Configuration Deploy

on:
  push:
    branches: [main, dev, feature/**]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  TF_IN_AUTOMATION: true

jobs:
  # ==========================================================================
  # STAGE 1: VALIDATION - Lint and validate all code
  # ==========================================================================
  validate-repository:
    name: "ðŸ“‹ Validate Repository"
    runs-on: ubuntu-latest
    steps:
      - name: "ðŸ” Checkout Repository"
        uses: actions/checkout@v4

      - name: "ðŸ Setup Python 3.13"
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: "ðŸ“¦ Install Python Dependencies"
        run: |
          pip install -r requirements.txt
          ansible-galaxy collection install -r requirements.yml || true

      - name: "ðŸ”§ Ansible Lint"
        run: |
          echo "Running Ansible lint checks..."
          ansible-lint --version
          ansible-lint || echo "âš ï¸ Ansible lint warnings found"

      - name: "ðŸ—ï¸ Setup Terraform"
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.7.5

      - name: "ðŸ”§ Terraform Init (Validation Mode)"
        working-directory: terraform
        run: terraform init -input=false -backend=false

      - name: "âœ… Terraform Validate"
        working-directory: terraform
        run: terraform validate

      - name: "ðŸ“ Terraform Format Check"
        working-directory: terraform
        run: |
          if ! terraform fmt -check; then
            echo "âŒ Terraform formatting issues found. Run 'terraform fmt' to fix."
            exit 1
          fi
          echo "âœ… Terraform formatting is correct"

  # ==========================================================================
  # STAGE 2: TERRAFORM PLAN - Plan infrastructure changes (runs on PR & main)
  # ==========================================================================
  terraform-plan:
    name: "ðŸ—ºï¸ Terraform Plan"
    needs: validate-repository
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      pull-requests: write  # For posting plan comments
    outputs:
      plan-output: ${{ steps.plan.outputs.stdout }}
    steps:
      - name: "ðŸ” Checkout Repository"
        uses: actions/checkout@v4

      - name: "ðŸ—ï¸ Setup Terraform"
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.7.5
          terraform_wrapper: false

      - name: "ðŸ” Authenticate to GCP"
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}

      - name: "âš™ï¸ Configure gcloud"
        uses: google-github-actions/setup-gcloud@v2

      - name: "ðŸ”„ Terraform Init"
        working-directory: terraform
        run: |
          echo "ðŸ”„ Initializing Terraform..."
          terraform init -input=false -backend-config=config/backend.hcl

      - name: "ðŸ“‹ Terraform Plan"
        id: plan
        working-directory: terraform
        run: |
          echo "ðŸ“‹ Creating Terraform execution plan..."
          terraform plan -input=false -detailed-exitcode \
            -var-file=config/terraform.tfvars \
            -out=tfplan
        continue-on-error: true

      - name: "ðŸ’¾ Save Terraform Plan"
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan
          path: terraform/tfplan
          retention-days: 7

  # ==========================================================================
  # STAGE 3: TERRAFORM APPLY - Deploy infrastructure (main branch only)
  # ==========================================================================
  terraform-apply:
    name: "ðŸš€ Terraform Apply"
    needs: [validate-repository, terraform-plan]
    if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    environment: production  # Require approval for production deployments
    steps:
      - name: "ðŸ” Checkout Repository"
        uses: actions/checkout@v4

      - name: "ðŸ—ï¸ Setup Terraform"
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.7.5

      - name: "ðŸ” Authenticate to GCP"
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}

      - name: "âš™ï¸ Configure gcloud"
        uses: google-github-actions/setup-gcloud@v2

      - name: "ðŸ”„ Terraform Init"
        working-directory: terraform
        run: |
          echo "ðŸ”„ Initializing Terraform..."
          terraform init -input=false -backend-config=config/backend.hcl

      - name: "ðŸš€ Terraform Apply"
        working-directory: terraform
        run: |
          echo "ðŸš€ Applying Terraform configuration..."
          terraform apply -auto-approve -input=false \
            -var-file=config/terraform.tfvars

      - name: "ðŸ“Š Terraform Output"
        working-directory: terraform
        run: |
          echo "ðŸ“Š Collecting Terraform outputs..."
          terraform output -json > tf-output.json
          echo "Infrastructure deployment completed successfully! âœ…"

      - name: "ðŸ’¾ Upload Terraform Outputs"
        uses: actions/upload-artifact@v4
        with:
          name: terraform-outputs
          path: terraform/tf-output.json
          retention-days: 30

  # ==========================================================================
  # STAGE 4: DEPLOY ANSIBLE CONFIGS - Push to GCS to trigger Cloud Build
  # ==========================================================================
  deploy-ansible-configs:
    name: "ðŸ“¦ Deploy Ansible Configurations"
    needs: [validate-repository, terraform-apply]
    if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: "ðŸ” Checkout Repository"
        uses: actions/checkout@v4

      - name: "ðŸ” Authenticate to GCP"
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}

      - name: "âš™ï¸ Configure gcloud"
        uses: google-github-actions/setup-gcloud@v2

      - name: "ðŸ“¦ Create Ansible Archive"
        run: |
          echo "ðŸ“¦ Creating Ansible configuration archive..."
          
          # Create archive excluding terraform directory and CI files
          tar -czf ansible-configs.tar.gz \
            --exclude='terraform' \
            --exclude='.github' \
            --exclude='.git' \
            --exclude='*.md' \
            --exclude='requirements.txt' \
            .
          
          echo "ðŸ“Š Archive contents:"
          tar -tzf ansible-configs.tar.gz | head -20

      - name: "â˜ï¸ Upload to GCS Bucket"
        run: |
          echo "â˜ï¸ Uploading Ansible configurations to GCS..."
          
          # Upload the archive
          gsutil cp ansible-configs.tar.gz gs://${{ secrets.ANSIBLE_BUCKET_NAME }}/
          
          # Upload individual files for direct access
          gsutil -m rsync -r -d \
            --exclude='terraform/**' \
            --exclude='.github/**' \
            --exclude='.git/**' \
            --exclude='*.md' \
            --exclude='requirements.txt' \
            . gs://${{ secrets.ANSIBLE_BUCKET_NAME }}/
          
          # Set metadata to trigger Cloud Build
          gsutil setmeta -h "x-goog-meta-deployed-by:github-actions" \
            -h "x-goog-meta-commit-sha:${{ github.sha }}" \
            -h "x-goog-meta-deploy-time:$(date -u +%Y%m%d-%H%M%S)" \
            gs://${{ secrets.ANSIBLE_BUCKET_NAME }}/ansible-configs.tar.gz
          
          echo "âœ… Ansible configurations deployed successfully!"
          echo "ðŸ”„ Cloud Build will now automatically configure the infrastructure..."

      - name: "ðŸ“Š Deployment Summary"
        run: |
          echo "## ðŸŽ‰ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Infrastructure Status" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Terraform validation passed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Infrastructure deployed successfully" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Ansible configurations uploaded to GCS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. ðŸ”„ Cloud Build will automatically trigger" >> $GITHUB_STEP_SUMMARY
          echo "2. ðŸ¤– Ansible Controller will configure all hosts" >> $GITHUB_STEP_SUMMARY
          echo "3. ðŸ“Š Check Cloud Build logs for configuration status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Useful Commands" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "# Check Cloud Build status" >> $GITHUB_STEP_SUMMARY
          echo "gcloud builds list --limit=5" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# View controller logs" >> $GITHUB_STEP_SUMMARY
          echo "gcloud compute ssh controller --zone=${{ secrets.GCP_ZONE || 'us-central1-a' }} --command='sudo journalctl -u google-startup-scripts.service -f'" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY


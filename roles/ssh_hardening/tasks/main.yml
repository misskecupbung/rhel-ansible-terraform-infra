---
- name: Ensure openssh server installed
  ansible.builtin.package:
    name: openssh-server
    state: present

- name: Harden sshd_config
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^{{ item.key }}'
    line: '{{ item.key }} {{ item.value }}'
    state: present
  loop:
    - { key: 'Protocol', value: '2' }
    - { key: 'PermitRootLogin', value: 'no' }
    - { key: 'PasswordAuthentication', value: 'no' }
    - { key: 'ClientAliveInterval', value: '300' }
    - { key: 'ClientAliveCountMax', value: '0' }
    - { key: 'X11Forwarding', value: 'no' }
  notify: Restart sshd

- name: Ensure secure permissions on sshd_config
  ansible.builtin.file:
    path: /etc/ssh/sshd_config
    owner: root
    group: root
    mode: '0600'
